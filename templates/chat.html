{% extends "base.html" %}

{% block mytitle %}Users - VoxWave{% endblock %}

{% block mycss %}
<style>
  body{
    background-color: #f2f2f2 !important;
  }
    /* Media query for screens smaller than 600px */
    @media (max-width: 767px) {
      /* Custom CSS rules for screens smaller than 600px */
      /* Adjust styles for smaller screens here */
      .desktop-only{
        display: none;
      }
      .mobile-only{
        display: block;
      }
      .left-header{
        position: fixed;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 80px;
        background-color: #cccccc; 
        border-bottom-right-radius: 20px; 
        border-bottom-left-radius: 20px;
        z-index: 999;
      }
      .dropdown-menu {
        display: none;
        position: absolute;
        background-color: #fff;
        border: 1px solid #ccc;
        padding: 5px;
        margin-right: 30px;
        width: 250px; /* Adjust the width as needed */
        right: 0;
    }
    
    .dropdown-menu a {
        display: block;
        padding: 5px;
        color: #000;
        text-decoration: none;
    }
    
    .dropdown-menu a:hover {
        background-color: #f0f0f0;
    }
    .friend-card{
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
    }
    .hr-line {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 80%;
      margin-bottom: 0px;
      margin-left: 40px;
      height: 2px;
      background-color: #cccccc; /* Adjust color as needed */
      border: none;
      /* Other styles for the hr */
  }
    .right-header{
      background-color: #cccccc;
      border-bottom-left-radius: 30px;
      z-index: 999;
      position: fixed;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 80px;
    }
    .message-display{
      height: 720px;
    }
    .message-input{
      width: 100%;
      height: 40px;
      padding-left: 10px;
    }

    .audio-input{
      width: 200px; 
      margin: 0px; 
      padding: 0px;
    }
    .record-icon{
      padding-top: 14px;
    }
    .send-icon{
      padding-top: 14px;
    }
    .message{
      background-color: white;
      padding-top: 10px;
      width: 80%;
    }
    .message-left {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    
    .message-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-bottom: 10px;
    }
    
    .message-left p,
    .message-right p {
      max-width: 80%;
      word-wrap: break-word;
      background-color: #f1f1f1;
      padding: 10px;
      margin-left: 20px;
      border-radius: 10px;
      margin-bottom: 5px;
    }
    
    .message-left audio,
    .message-right audio {
      max-width: 90%;
      margin-bottom: 5px;
    }
    
    .message-left .message-actions,
    .message-right .message-actions {
      display: flex;
      align-items: center;
    }
    
    .message-left .message-actions button,
    .message-right .message-actions button {
      margin-right: 10px;
    }
    .msg-container{
      position: relative;
    }
    .hidden {
      display: none;
    }
    }

    /* Media query for screens between 601px and 900px */
    @media (min-width: 768px) and (max-width: 899px){
      /* Custom CSS rules for screens between 601px and 900px */
      /* Adjust styles for medium-sized screens here */
      .desktop-only{
        display: none;
      }
      .mobile-only{
        display: block;
      }
    }

    @media screen and ((min-width: 900px) and (max-width: 1199px)) {
      .desktop-only{
        display: block;
      }
      .mobile-only{
        display: none;
      }
    }
    
    /* Media query for screens larger than 901px */
    @media screen and ((min-width: 1200px) and (max-width: 1700px)) {
      /* Custom CSS rules for screens larger than 901px */
      /* Adjust styles for larger screens here */
      
      .desktop-only{
        display: block;
      }
      .mobile-only{
        display: none;
      }
    }
    /* Media query for screens larger than 901px */
    @media screen and (min-width: 1701px) {
      /* Custom CSS rules for screens larger than 901px */
      /* Adjust styles for larger screens here */
      
      .desktop-only{
        display: block;
      }
      .mobile-only{
        display: none;
      }
    }
    

</style>
{% endblock %}

{% block mybody %}
<!--<div class="w3-container desktop-only" style="padding: 0px; margin: 0px; position: relative;">
    <div class="w3-container left-side" style="position: absolute;">
      <div class="w3-container w3-round-xxlarge" style="padding-left: 5px; background-color: white;">
        <div class="w3-container left-header w3-round-xxlarge w3-card-4">
          <div class="dropdown w3-cell w3-left">
            <img src="{{user_profile.profileimg.url}}" class="w3-circle dropdown-toggle" style="width: 40px; height:40px; cursor: pointer;" alt="">
            <div class="dropdown-menu w3-card-4 w3-round-large">
                
                <a href="/profile/{{user.username}}">Your Profile</a>
                <a href="/settings">Account Settings</a>
                <a href="/logout">Logout</a>
            </div> 
          </div>
            <div class="w3-container w3-cell w3-right">
              <a href="/" style="text-decoration: none;"><h3><b>VoxWave</b></h3></a>
            </div>
        </div>
      </div>
      <div class="w3-container friend-list-container" style="margin-top: 20px;">
            {% for friends in friends_list %}
            <div class="w3-hover-shadow w3-round-xxlarge friend-card">
              <div class="w3-container w3cell w3-left" style="margin-top: 25px;">
                <a href="/profile/{{friends.user}}">
                  <img src="{{friends.profileimg.url}}" class="w3-circle" style="width: 40px; height:40px; cursor: pointer;">
                </a>
              </div>
              <div class="w3-container w3cell w3-left friend-card-name" style="margin-top: 10px; padding-left: 30px;">
                  <p class="capitalize"><b>{{friends.user}}</b></p>
                  
              </div>
              <div class="w3-container w3cell w3-right desktop-only" style="margin-top: 25px;">
                <button type="button" onclick="document.getElementById('messages').style.display='block'; document.getElementById('blank-page').style.display='none'; displayMessages('{{ friends.user }}', '{{ friends.profileimg.url }}');" class="w3-btn w3-border w3-round-large " style="background-color: #cccccc; color: white;"> <b>Message</b> </button>
              </div>
          
            </div> 
            {% endfor %}
      </div>
    </div>
    <div class="w3-container right-side" style="position: absolute;">
      <div class="w3-center w3-display-middle" id="blank-page">
          <h3 style="color: #cccccc;"><b> Your Messages....!!!</b></h3>
      </div>
      <div class="w3-container" id="messages" style="display: none; padding-right: 0px;">
        <header class="w3-container message-display-header w3-round w3-card-4">
          <div class="w3-container w3cell w3-left" style="margin-top: 20px;">
            <a id="profile-link">
              <img  id="profile-image" class="w3-circle" style="width: 40px; height:40px; cursor: pointer;">
            </a>
          </div>
          <div class="w3-container w3cell w3-left" style="margin-top: 18px;">
              <h3 id="friendUsername" class="capitalize" style="padding-left: 60px;"></h3>
          </div>
        </header>
        <div class="w3-container message-display w3-border w3-round w3-card-4" id="message-display-area">

        </div>
        <footer class="w3-container message-display-footer w3-round w3-card-4">
            <div class="w3-container w3-cell w3-center foot1">
              
              <input type="text" id="messageInput" class="message-input w3-round-large" placeholder="Type your message..." onkeydown="if (event.key === 'Enter') { document.getElementById('send-icon').click(); event.preventDefault(); }" />
              <audio class="message-input" id="audioInput" controls hidden></audio>
            </div>
            <div class="w3-container w3-cell w3-center foot2">
              <b><button type="button" style="background-color: transparent; border: none; cursor: pointer" onclick="recordMessage();" id="record-icon" class="record-icon">Record</button></b>
            </div>
            <div class="w3-container w3-cell w3-center foot3">
              <button type="button" style="background-color: transparent; border: none; cursor: pointer" onclick="sendMessage();" id="send-icon" class="send-icon"><i class="fa fa-paper-plane" aria-hidden="true" style="font-size: 25px;"></i></button>
            </div>
        </footer>
      </div>
    </div>
</div>-->

<div class="w3-container mobile-only" style="width: 100%; height: 30px; padding: 0px;">

  <div class="w3-container left-side" id="contacts" style="width: 100%; padding: 0px;">

    <div class="w3-container left-header w3-card-4">

        <div class="w3-container w3-cell w3-left" style="padding-top: 10px;">
          <a href="/" style="text-decoration: none;"><h3 style="color: white;"><b>VoxWave</b></h3></a>
        </div>
        <div class="dropdown w3-cell w3-right" style="padding-top: 14px; padding-right: 20px;">
          <img src="{{user_profile.profileimg.url}}" class="w3-circle dropdown-toggle w3-border" style="width: 40px; height:40px; cursor: pointer;" alt="">
          <div class="dropdown-menu w3-card-4 w3-round-large">
              
              <a href="/profile/{{user.username}}">Your Profile</a>
              <a href="/settings">Account Settings</a>
              <a href="/logout">Logout</a>
          </div> 
        </div>
    </div>

    <div class="w3-container" style="width: 100%;">

      <div class="w3-container" style="margin-top: 100px;">

        {% for friends in friends_list %}
        <div class="w3-hover-shadow w3-round-xxlarge friend-card" style="position: relative;" onclick="document.getElementById('contacts').style.display='none'; document.getElementById('messages').style.display='block'; displayMessages('{{ friends.user }}', '{{ friends.profileimg.url }}');">
          <div class="w3-container w3cell w3-left" style="margin-top: 25px; margin-left: 20px;">
            <a href="/profile/{{friends.user}}">
              <img src="{{friends.profileimg.url}}" class="w3-circle" style="width: 40px; height:40px; cursor: pointer;">
            </a>
          </div>
          <div class="w3-container w3cell w3-left friend-card-name" style="margin-top: 20px; padding-left: 50px;">
            <p><h5 class="capitalize"><b>{{friends.user}}</b></h5></p>
          </div>
          <hr class="hr-line">
        </div> 
        {% endfor %}
      </div>
    </div>
  </div>
  
  <div class="w3-container right-side" id="messages" style="width: 100%; padding: 0px; display: none;">

      <div class="w3-container right-header w3-card-4">

        <div class="w3-container w3cell w3-left" style="margin-top: 20px;">
          <a href="/message_page">
            <img  id="profile-image" class="w3-circle" style="width: 40px; height:40px; cursor: pointer;">
          </a>
        </div>
        <div class="w3-container w3cell w3-left" style="margin-top: 18px;">
          <a href="/message_page" style="text-decoration: none;">
            <h3 id="friendUsername" class="capitalize" style="padding-left: 60px;"></h3>
          </a>
        </div>
      </div>

      <div class="w3-container message-display" id="message-display-area" style="padding-top: 100px; overflow-y: auto;">

      </div>
      <div class="w3-container">
        <div class="w3-container w3-cell w3-center" id="input-container" >
              
          <input  type="text" id="messageInput" class="message-input w3-round-large" placeholder="Type your message..." onkeydown="if (event.key === 'Enter') { document.getElementById('send-icon').click(); event.preventDefault(); }" />
          <audio class="audio-input" id="audioInput" controls hidden></audio>
        </div>
        
        <div class="w3-container w3-cell w3-center">
          <b><button type="button" style="background-color: transparent; border: none; cursor: pointer"  onclick="recordMessage();" id="record-btn" class="record-icon">Record</button></b>
        </div>
        <div class="w3-container w3-cell w3-center">
          <button type="button" style="background-color: transparent; border: none; cursor: pointer" onclick="sendMessage();" id="send-icon" class="send-icon"><i class="fa fa-paper-plane" aria-hidden="true" style="font-size: 25px;"></i></button>
        </div>
      </div>
  </div>

</div>
{% endblock %}
    
{% block myscript %}
<script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
<script>
  let friend
  let fetchCount = 0;

  // Define the function to fetch chat at regular intervals
  function fetchChatAtRegularInterval() {
    const intervalId = setInterval(() => {
        if (fetchCount < 3) {
            fetchChat(friend);
            fetchCount++;
        } else {
            clearInterval(intervalId); // Stop the interval after 3 times
            fetchCount = 0;
        }
    }, 2000); // 2000 milliseconds = 2 seconds
  }

  function fetchChat(username) {
    var messageDisplay = document.getElementById('message-display-area');
    var currentUser = "{{ user.username }}";
    // Fetch chat data from the backend
    fetch('/chat/' + username + '/')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      // Clear existing content of message display area
      messageDisplay.innerHTML = '';

      // Loop through chat messages and populate message display area
      data.chat_history.forEach(message => {
        var messageDiv = document.createElement('div');
        messageDiv.className = 'w3-container msg-container';

        // Create message content based on message type
        var messageContent = '';
        if (message.chat_text) {
          messageContent = `
          <div class='message w3-round-xlarge'>
                <p>${message.chat_text}
                  ${message.emotion_class? `
                  ${message.chat_from === currentUser ? `
                    <button type="button" class="w3-btn w3-round-xlarge" onclick="deleteChat('${message.chat_id}')" > <b><i class="fa fa-trash" style="font-size: 20px; position: absolute; top:30px; right: 30px;"></i></b> </button>`: ''}</p>
                  
                <button onclick="myEmotion('class_${message.chat_id}')" class="w3-btn w3-round-xlarge">
                  <i class="fa fa-etsy" aria-hidden="true"></i></button>
                  
                  `: ''}
                </div>
                <br>
                  <div id="class_${message.chat_id}" class="w3-hide" style="margin: 0px; padding: 0px; width: 100%;">
                    <p style="background-color: #f2f2f2; width: 80%;">${message.emotion_class}</p>
                  </div>
                `;
        } else if (message.audio_url) {
          messageContent = `
          
          <div class='message w3-round-xlarge'>
                <audio controls style="width: 70%;"><source src="${message.audio_url}" type="audio/mpeg">Your browser does not support the audio element.</audio>
                
                  ${message.chat_from === currentUser ? `
                    <button type="button" class="w3-btn w3-round-xlarge" onclick="deleteChat('${message.chat_id}')"> <b><i class="fa fa-trash" style="font-size: 20px; position: absolute; top:30px; right: 30px;"></i></b> </button>`: ''}
                    ${message.transcript && message.emotion_class? `
                <button onclick="myEmotion('class_${message.chat_id}')" class="w3-btn w3-round-xlarge">
                  <i class="fa fa-text-width" aria-hidden="true" style="font-size: 20px;"></i></button>
                  
                  `: ''}
                </div>
                <br>
                  <div id="class_${message.chat_id}" class="w3-hide" style="margin: 0px; padding: 0px; width: 100%;">
                    <p style="background-color: #f2f2f2; width: 90%;">${message.transcript}<br>Emotion: ${message.emotion_class}</p>
                      <!--<br>
                      <button  class="w3-btn">
                        <i class="fa fa-text-width" aria-hidden="true" style="font-size: 20px;"></i></button>-->
                  </div>
          `;
        }
        // Add other message types as needed

        // Add message content to message div
        messageDiv.innerHTML = messageContent;

        // Add a CSS class based on message sender
        if (message.chat_from === '{{ request.user.username }}') {
          messageDiv.classList.add('message-right');
        } else {
          messageDiv.classList.add('message-left');
        }

        // Append message div to message display area
        messageDisplay.appendChild(messageDiv);
        
      });

      // Set the scrollbar to the bottom after adding new messages
      messageDisplay.scrollTop = messageDisplay.scrollHeight;
    })
    .catch(error => {
      console.error('There was a problem with your fetch operation:', error);
    });
  }

    document.addEventListener("DOMContentLoaded", function() {
      var dropdowns = document.querySelectorAll('.dropdown');
      

      dropdowns.forEach(function(dropdown) {
          var button = dropdown.querySelector('.dropdown-toggle');
          var menu = dropdown.querySelector('.dropdown-menu');

          button.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent event bubbling

                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
          });

          document.addEventListener('click', function(event) {
                var target = event.target;
                if (!dropdown.contains(target)) {
                    menu.style.display = 'none';
                }
          });
      });

      window.displayMessages = function (friend_username, profileimg_url) {
        // Get the elements by their IDs
        var profileImage = document.getElementById('profile-image');
        var headerUsername = document.getElementById('friendUsername');
        
        friend = friend_username;
  
        // Set the header username
        headerUsername.innerHTML = "<b>" + friend_username + "</b>";
  
  
        // Set the src attribute of the profile image
        profileImage.src = profileimg_url;
  
        fetchChat(friend_username);
      };


// Function to simulate recording a message
let mediaRecorder;
let recordedChunks = [];
let is_recording = false;
let audioBlob;

window.recordMessage = async function () {
    const recordButton = document.getElementById('record-btn');
    const isRecording = recordButton.textContent === 'Stop'; // Check current state
    
    if (!isRecording && recordButton.textContent === "Record") {
        // Start recording
        recordButton.textContent = 'Stop';
        
        is_recording = true;

        try {
            // Request permission from the user to access their microphone
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            // Start audio recording
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.addEventListener('dataavailable', event => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            });
            mediaRecorder.start();
        } catch (error) {
            //message.value = error;
            console.error('Error accessing microphone:', error);
            // Reset the button text if there's an error
            recordButton.textContent = 'Record';
            is_recording = false;
        }

    } 
    else if (recordButton.textContent === "Delete") {
        // User clicked Delete after stopping recording
        audioBlob = null;
        audioInput.hidden = true;
        messageInput.hidden = false;
        recordButton.textContent = "Record";
    }
    else {
        // Stop recording
        recordButton.textContent = 'Delete';
        is_recording = false;

        // Stop audio recording
        mediaRecorder.stop();

        // Wait a bit before creating the Blob to ensure all data is available
        await new Promise(resolve => setTimeout(resolve, 500));

        // Create a Blob from the recorded chunks
        audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });

        // Reset recordedChunks array
        recordedChunks = [];

        // Create an object URL for the audio Blob and set it as the source for the audio tag
        const audioUrl = URL.createObjectURL(audioBlob);
        const audioInput = document.getElementById('audioInput');
        audioInput.src = audioUrl;

        // Show the audio controls
        audioInput.hidden = false;

        // Hide the text input
        document.getElementById('messageInput').hidden = true;
    }
};

      // Function to generate a random filename of length 7
      window.generateRandomFilename = function () {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let randomFilename = '';
        for (let i = 0; i < 7; i++) {
            randomFilename += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return randomFilename;
    };

    window.sendMessage = function(){
      //console.log(friend)
      const messageInput = document.getElementById('messageInput').value;
      document.getElementById('messageInput').value = '';
      // Create FormData object to send both text message and audio Blob to the backend
      const formData = new FormData();
      if(messageInput){
          formData.append('message', messageInput);
          audioBlob = null;
      }
      
      formData.append('friend_username', friend);
      if (audioBlob) {
          // Generate a random filename
          const randomFilename = generateRandomFilename();
          formData.append('audio', audioBlob, randomFilename + '.webm');
          
      }
      // Send the FormData object via fetch
      fetch('/chat', {
          method: 'POST',
          body: formData
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          audioBlob = null;
          const audioInput = document.getElementById('audioInput');
          audioInput.hidden = true;
          const messageInput = document.getElementById('messageInput');
          messageInput.hidden = false;
          const recordButton = document.querySelector('.record-icon');
          recordButton.textContent = "Record";
          return response.json();
      })
      .then(data => {
          console.log('Message sent: ', data);
          // Optionally handle response data here
          fetchChat(friend);
          if (data.status === 'success') {
            fetchChatAtRegularInterval();
        }
      })
      .catch(error => {
          console.error('There was a problem with sending the message:', error);
          // Optionally handle errors here
      });
    };

window.myEmotion = function (id) {
  var x = document.getElementById(id);
  if (x.className.indexOf("w3-show") == -1) {
    x.className += " w3-show";
  } else { 
    x.className = x.className.replace(" w3-show", "");
  }
}


    });

    

    
        
    function deleteChat(chat_id) {
      // Make a fetch request to delete the chat with the given chat_id
      fetch(`/delete-chat/${chat_id}`, {
          method: 'DELETE'
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          // Upon successful deletion, call the fetchChat function to refresh chat data
          fetchChat(friend);
      })
      .catch(error => {
          console.error('There was a problem with deleting the chat:', error);
          // Handle errors here if needed
      });
  }

</script>
{% endblock %}